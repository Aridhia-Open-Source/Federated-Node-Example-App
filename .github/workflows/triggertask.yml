name: Update Task
run-name: update_task
on:
  push:
    branches:
      - pipe-test

env:
  GH_TOKEN: ${{ secrets.SA_TOKEN }}

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-merge
          token: ${{ env.GH_TOKEN }}
      - name: Update values
        run: |
          AUTHOR=$(gh pr list -B main --state merged --json author,mergedAt,mergedBy,headRefName,number | jq '.[0].author.login')
          git config --global user.name 'BotMan'
          git config --global user.email 'r-casula@users.noreply.github.com'
          cat argo/task.json | jq ".spec.user |= .+ {\"username\": \"$AUTHOR\"}" > temp.json
          mv temp.json argo/task.json
          git add argo/task.json
          git commit -am "Added user info"
          git push
