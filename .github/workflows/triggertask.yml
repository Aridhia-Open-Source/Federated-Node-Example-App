name: Update Task
run-name: update_task
on:
  push:
    branches:
      - pipe-test

env:
  GH_TOKEN: ${{ secrets.SA_TOKEN }}
  DEST_BRANCH: argo-monitor
  TEMPLATE_PATH: argo/task.json

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Save template
        run: |
          echo "TEMPL_CONTENTS=$(cat ${{ env.TEMPLATE_PATH }})" >> "$GITHUB_ENV"

      - name: Checkout Argo Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEST_BRANCH }}
          token: ${{ env.GH_TOKEN }}
      - name: Update values
        run: |
          AUTHOR=$(gh pr list -B pipe-test --state merged --json author,mergedAt,mergedBy,headRefName,number | jq '.[0].author.login')
          if [[ "$AUTHOR" == 'null' ]]; then
            echo "No user found"
            exit 1
          fi
          git config --global user.name 'BotMan'
          git config --global user.email 'r-casula@users.noreply.github.com'

          echo "$TEMPL_CONTENTS" | jq ".spec |= .+ {\"user\": {\"username\": $AUTHOR}, \"repository\": \"${{ github.repository }}\", \"organization\": \"${{ github.repository_owner }}\"}" > ${{ env.TEMPLATE_PATH }}
          git add ${{ env.TEMPLATE_PATH }}
          git commit -am "Added user info"
          git push
